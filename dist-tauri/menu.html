<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Praymodoro Menu</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Helvetica Neue', sans-serif;
      font-size: 13px;
      background: transparent;
      overflow: hidden;
      padding: 5px 15px 10px 15px;
    }

    .menu {
      background: transparent;
      border-radius: 6px;
      padding: 5px 0;
      min-width: 200px;
    }

    .menu-item {
      padding: 4px 12px;
      cursor: default;
      color: #000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 22px;
      line-height: 22px;
    }

    .menu-item:not(.disabled):hover {
      background: #007aff;
      color: #fff;
    }

    .menu-item.disabled {
      color: rgba(0, 0, 0, 0.35);
      cursor: default;
    }

    .separator {
      height: 1px;
      background: rgba(0, 0, 0, 0.1);
      margin: 5px 0;
    }

    .menu-label {
      flex: 1;
    }

    .menu-item.menu-title {
      font-weight: 600;
      color: #000;
    }

    .menu-item.size-row,
    .menu-item.size-row:hover {
      background: transparent;
      color: inherit;
      cursor: default;
    }

    .size-controls {
      display: flex;
      gap: 4px;
    }

    .size-btn {
      width: 20px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.06);
      cursor: default;
      font-weight: 500;
      font-size: 14px;
    }

    .size-btn:not(.disabled):hover {
      background: #007aff;
      color: #fff;
    }

    .size-btn.disabled {
      opacity: 0.35;
      pointer-events: none;
    }

    .menu-item.character-row,
    .menu-item.character-row:hover {
      background: transparent;
      color: inherit;
      cursor: default;
    }

    .character-controls {
      display: flex;
      gap: 4px;
    }

    .char-btn {
      padding: 0 8px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.06);
      cursor: default;
      font-size: 11px;
    }

    .char-btn:hover {
      background: #007aff;
      color: #fff;
    }

    @media (prefers-color-scheme: dark) {
      .menu {
        background: transparent;
      }

      .menu-item {
        color: rgba(255, 255, 255, 0.9);
      }

      .menu-item.size-row {
        color: rgba(255, 255, 255, 0.9);
      }

      .menu-item:not(.disabled):hover {
        background: #0a84ff;
        color: #fff;
      }

      .menu-item.disabled {
        color: rgba(255, 255, 255, 0.4);
      }

      .menu-item.menu-title {
        color: rgba(255, 255, 255, 0.95);
      }

      .separator {
        background: rgba(255, 255, 255, 0.12);
      }

      .size-btn {
        background: rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.9);
      }

      .size-btn:not(.disabled):hover {
        background: #0a84ff;
        color: #fff;
      }

      .char-btn {
        background: rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.9);
      }

      .char-btn:hover {
        background: #0a84ff;
        color: #fff;
      }
    }
  </style>
</head>
<body>
  <div class="menu" id="menu">
    <div class="menu-item disabled menu-title">
      <span class="menu-label">Praymodoro</span>
    </div>
    <div class="separator"></div>
    <div class="menu-item disabled" id="countdown">
      <span class="menu-label">Work for: 25:00</span>
    </div>
    <div class="separator"></div>
    <div class="menu-item size-row">
      <span class="menu-label" id="size-label">Size: 100%</span>
      <div class="size-controls">
        <span class="size-btn" id="decrease-size">âˆ’</span>
        <span class="size-btn" id="increase-size">+</span>
      </div>
    </div>
    <div class="separator"></div>
    <div class="menu-item disabled" id="character-label">
      <span class="menu-label">Character: Augustine</span>
    </div>
    <div class="menu-item character-row">
      <div class="character-controls">
        <span class="char-btn" id="toggle-character">Hide</span>
        <span class="char-btn" id="next-character">Next</span>
      </div>
    </div>
    <div class="separator"></div>
    <div class="menu-item" id="quit">
      <span class="menu-label">Quit</span>
    </div>
  </div>

  <script type="module">
    const { invoke } = window.__TAURI__.core;
    const { listen } = window.__TAURI__.event;
    const { getCurrentWindow } = window.__TAURI__.window;

    let currentMode = 'work';

    function formatCharacterName(name) {
      return name
        .split('-')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    function getModeLabel(mode) {
      return mode === 'work' ? 'Work for:' : 'Pray for:';
    }

    async function updateUI() {
      try {
        const state = await invoke('get_menu_state');
        currentMode = state.mode;

        // Update countdown
        const countdownEl = document.getElementById('countdown');
        if (countdownEl) {
          countdownEl.querySelector('.menu-label').textContent = `${getModeLabel(state.mode)} ${state.countdown}`;
        }

        // Update toggle character button
        const toggleEl = document.getElementById('toggle-character');
        if (toggleEl) {
          toggleEl.textContent = state.isCharacterVisible ? 'Hide' : 'Show';
        }

        // Update size label and button states
        const sizeEl = document.getElementById('size-label');
        if (sizeEl) {
          const scalePercent = Math.round(state.scale * 100);
          sizeEl.textContent = `Size: ${scalePercent}%`;
        }

        // Disable size buttons at min/max
        const decreaseBtn = document.getElementById('decrease-size');
        const increaseBtn = document.getElementById('increase-size');
        if (decreaseBtn) {
          decreaseBtn.classList.toggle('disabled', state.scale <= 1.0);
        }
        if (increaseBtn) {
          increaseBtn.classList.toggle('disabled', state.scale >= 3.0);
        }

        // Update character label
        const characterEl = document.getElementById('character-label');
        if (characterEl) {
          const label = characterEl.querySelector('.menu-label');
          if (label) {
            label.textContent = `Character: ${formatCharacterName(state.character)}`;
          }
        }
      } catch (e) {
        console.error('Failed to get menu state:', e);
      }
    }

    // Listen for time updates
    listen('menu-time-update', (event) => {
      const countdown = event.payload;
      const countdownEl = document.getElementById('countdown');
      if (countdownEl) {
        const label = countdownEl.querySelector('.menu-label');
        if (label) {
          label.textContent = `${getModeLabel(currentMode)} ${countdown}`;
        }
      }
    });

    // Listen for mode updates
    listen('menu-mode-update', (event) => {
      currentMode = event.payload;
    });

    // Close menu when pressing escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        invoke('close_menu');
      }
    });

    // Setup button handlers
    document.getElementById('toggle-character')?.addEventListener('click', async () => {
      await invoke('menu_action', { action: 'toggle-character' });
      await updateUI();
    });

    document.getElementById('increase-size')?.addEventListener('click', async () => {
      await invoke('menu_action', { action: 'increase-size' });
      await updateUI();
    });

    document.getElementById('decrease-size')?.addEventListener('click', async () => {
      await invoke('menu_action', { action: 'decrease-size' });
      await updateUI();
    });

    document.getElementById('next-character')?.addEventListener('click', async () => {
      await invoke('menu_action', { action: 'next-character' });
      await updateUI();
    });

    document.getElementById('quit')?.addEventListener('click', () => {
      invoke('menu_action', { action: 'quit' });
    });

    // Initialize
    updateUI();
  </script>
</body>
</html>
